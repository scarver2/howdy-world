#!/usr/bin/env bash
# bin/new
source "$(dirname "$0")/_lib.sh"
cd "$ROOT_DIR"

usage() {
  echo "Usage: bin/new <endpoint-name>"
  exit 1
}

NAME="${1:-}"
[[ -z "$NAME" ]] && usage

# Enforce lowercase kebab-case starting with alpha
if ! [[ "$NAME" =~ ^[a-z][a-z0-9-]*$ ]]; then
  echo "${RED}Invalid endpoint name.${RESET}"
  echo "Must be lowercase kebab-case and start with a letter."
  exit 1
fi

if [[ -d "$NAME" ]]; then
  echo "${RED}Endpoint '$NAME' already exists.${RESET}"
  exit 1
fi

echo "Creating endpoint: $NAME"
echo

mkdir -p "$NAME"

# -------------------------
# Dockerfile
# -------------------------
cat > "$NAME/Dockerfile" <<EOF
FROM alpine:3.20
RUN apk add --no-cache lighttpd
COPY index.html /var/www/localhost/htdocs/index.html
EXPOSE 3000
CMD ["lighttpd", "-D", "-f", "/etc/lighttpd/lighttpd.conf"]
EOF

# -------------------------
# Dockerfile.dev
# -------------------------
cat > "$NAME/Dockerfile.dev" <<EOF
FROM alpine:3.20
RUN apk add --no-cache lighttpd
COPY . /var/www/localhost/htdocs
EXPOSE 3000
CMD ["lighttpd", "-D", "-f", "/etc/lighttpd/lighttpd.conf"]
EOF

# -------------------------
# compose.yml
# -------------------------
cat > "$NAME/compose.yml" <<EOF
services:
  $NAME:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    restart: unless-stopped
EOF

# -------------------------
# compose.dev.yml
# -------------------------
cat > "$NAME/compose.dev.yml" <<EOF
services:
  $NAME:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./:/var/www/localhost/htdocs
    restart: unless-stopped
EOF

# -------------------------
# .dockerignore
# -------------------------
cat > "$NAME/.dockerignore" <<EOF
.git
node_modules
dist
target
.DS_Store
EOF

# -------------------------
# index.html
# -------------------------
cat > "$NAME/index.html" <<EOF
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>$NAME</title>
</head>
<body>
  <h1>Howdy from $NAME</h1>
</body>
</html>
EOF

# -------------------------
# .gitignore attempt
# -------------------------
GITIGNORE_URL="https://raw.githubusercontent.com/github/gitignore/main/${NAME^}.gitignore"

if curl --silent --head --fail "$GITIGNORE_URL" > /dev/null; then
  curl --silent "$GITIGNORE_URL" -o "$NAME/.gitignore"
  echo "${GREEN}Fetched GitHub gitignore template.${RESET}"
else
  touch "$NAME/.gitignore"
  echo "${YELLOW}Created blank .gitignore.${RESET}"
fi

# -------------------------
# nginx route
# -------------------------
NGINX_CONF="nginx/conf.d/${NAME}.conf"

cat > "$NGINX_CONF" <<EOF
location = /$NAME {
  return 301 /$NAME/;
}

location ^~ /$NAME/ {
  proxy_pass http://$NAME:3000/;
  proxy_set_header Host \$host;
  proxy_set_header X-Forwarded-Proto \$scheme;
  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
}
EOF

echo
echo "${GREEN}Endpoint '$NAME' created successfully.${RESET}"
echo "Remember to rebuild root stack."

exit 0

