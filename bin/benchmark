#!/usr/bin/env bash
# bin/benchmark

source "$(dirname "$0")/_lib.sh"
cd "$ROOT_DIR"

echo "Running Howdy World Benchmark"
echo

############################################
# CONFIG (alphabetical order)
############################################
CONCURRENCY="${CONCURRENCY:-20}"
DURATION="${DURATION:-5s}"
HOST="${HOST:-http://howdy.localhost}"
REQUESTS="${REQUESTS:-0}"   # if >0 overrides DURATION
TIMEOUT="${TIMEOUT:-10}"

############################################
# PRECHECKS
############################################
require_command docker
require_command hey

############################################
# DISCOVER ENDPOINTS
############################################
# Exclude infrastructure and dashboard
ENDPOINTS=($(docker compose config --services | grep -vE '^(dashboard|infrastructure|proxy)$' | sort))

if [[ ${#ENDPOINTS[@]} -eq 0 ]]; then
  abort "No endpoints discovered."
fi

############################################
# HEADER
############################################
banner

echo "ðŸ‡ Howdy World Benchmark"
echo "-----------------------------------------------"
echo "Concurrency : $CONCURRENCY"
echo "Duration    : $DURATION"
echo "Requests    : ${REQUESTS:-auto}"
echo

printf "%-25s %-12s %-12s %-12s %-8s\n" "Endpoint" "Req/sec" "Avg(ms)" "P95(ms)" "Errors"
printf "%-25s %-12s %-12s %-12s %-8s\n" "--------" "--------" "-------" "-------" "------"

############################################
# BENCH LOOP
############################################
for service in "${ENDPOINTS[@]}"; do

  URL="$HOST/$service/"

  if [[ "$REQUESTS" -gt 0 ]]; then
    OUTPUT=$(hey -c "$CONCURRENCY" -n "$REQUESTS" -t "$TIMEOUT" "$URL" 2>/dev/null)
  else
    OUTPUT=$(hey -c "$CONCURRENCY" -z "$DURATION" -t "$TIMEOUT" "$URL" 2>/dev/null)
  fi

  # Extract metrics
  RPS=$(echo "$OUTPUT" | awk '/Requests\/sec/ {print $2}')
  AVG=$(echo "$OUTPUT" | awk '/Average:/ {print $2}' | sed 's/ms//')
  P95=$(echo "$OUTPUT" | awk '/95%/ {print $2}' | sed 's/ms//')
  ERRORS=$(echo "$OUTPUT" | awk '/Non-2xx or 3xx responses/ {print $5}')

  RPS=${RPS:-0}
  AVG=${AVG:-0}
  P95=${P95:-0}
  ERRORS=${ERRORS:-0}

  printf "%-25s %-12s %-12s %-12s %-8s\n" "$service" "$RPS" "$AVG" "$P95" "$ERRORS"

done

echo
echo "âœ… Benchmark complete."
echo