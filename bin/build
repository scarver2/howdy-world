#!/usr/bin/env bash
# bin/build
source "$(dirname "$0")/_lib.sh"

usage() {
  cat <<'USAGE'
Usage:
  bin/build                 # build all services in compose.yml
  bin/build <service>       # build one service
  bin/build --list          # list services
  bin/build --no-cache      # build all, no cache
  bin/build <service> --no-cache

Examples:
  bin/build
  bin/build nginx
  bin/build --no-cache
  bin/build rust-leptos --no-cache

Notes:
- Pass-through args are supported after the optional <service>.
USAGE
}

if [[ "${1:-}" == "--list" ]]; then
  services
  exit 0
fi

SERVICE=""
if [[ $# -gt 0 && "${1:0:1}" != "-" ]]; then
  SERVICE="$1"
  shift
fi

if [[ -n "$SERVICE" ]]; then
  validate_service "$SERVICE"
  compose build "$@" "$SERVICE"
else
  compose build "$@"
fi