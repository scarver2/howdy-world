#!/usr/bin/env bash
# bin/status

source "$(dirname "$0")/_lib.sh"
cd "$ROOT_DIR"

usage() {
  cat <<'USAGE'
Usage:
  bin/status                 # docker compose ps
  bin/status --all           # ps + images
  bin/status --http          # ps + quick HTTP smoke check to howdy.localhost
  bin/status --http --base http://howdy.localhost

Notes:
- Root stack is production-only; this is just a friendly wrapper.
USAGE
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

banner

DO_ALL=0
DO_HTTP=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --all)  DO_ALL=1; shift ;;
    --http) DO_HTTP=1; shift ;;
    --base) BASE_URL="${2:-}"; shift 2 ;;
    *) echo "Unknown option: $1"; echo; usage; exit 2 ;;
  esac
done

compose ps

if (( DO_ALL == 1 )); then
  echo
  echo "Images"
  compose images
fi

if (( DO_HTTP == 1 )); then
  echo
  echo "HTTP smoke (2xx = OK): ${BASE_URL}"

  # Minimal curated list; edit to match your root routing.
  CHECKS=(
    "/"
    "/javascript-react/"
    "/jquery4/"
    "/go/"
    "/elixir-bandit/"
    "/elixir-phoenix/"
    "/java-spring-boot/"
    "/rust-leptos/"
    "/dotnet/"
  )

  fails=0
  for ep in "${CHECKS[@]}"; do
    url="${BASE_URL}${ep}"
    code="$(http_code "$url")"
    [[ -n "$code" ]] || code="???"

    printf "%-40s " "$ep"
    if [[ "$code" =~ ^2[0-9][0-9]$ ]]; then
      ok "HTTP $code"
    else
      ((fails++))
      fail "HTTP $code"
    fi
  done

  echo
  if (( fails == 0 )); then
    ok "All HTTP checks passed"
  else
    fail "$fails HTTP check(s) failing"
    exit 1
  fi
fi
