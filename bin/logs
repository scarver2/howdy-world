#!/usr/bin/env bash
# bin/logs
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

COMPOSE_FILE="${COMPOSE_FILE:-compose.yml}"

usage() {
  cat <<'USAGE'
Usage:
  bin/log                     # tail logs for all services
  bin/log <service>           # tail logs for one service
  bin/log <service> -f        # follow
  bin/log -f                  # follow all
  bin/log --list              # list services

Examples:
  bin/log nginx -f
  bin/log rust-leptos
  bin/log -f
USAGE
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fisource "$(dirname "$0")/_lib.sh"

if [[ "${1:-}" == "--list" ]]; then
  services
  exit 0
fi

SERVICE=""
if [[ $# -gt 0 && "${1:0:1}" != "-" ]]; then
  SERVICE="$1"
  shift
fi

TAIL_LINES="${TAIL_LINES:-200}"

if [[ -n "$SERVICE" ]]; then
  validate_service "$SERVICE"
  compose logs --tail="$TAIL_LINES" "$@" "$SERVICE"
else
  compose logs --tail="$TAIL_LINES" "$@"
fi