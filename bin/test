#!/usr/bin/env bash
# bin/test

source "$(dirname "$0")/_lib.sh"
cd "$ROOT_DIR"

banner

# -----------------------------
# Assets
# -----------------------------
echo "Checking assets..."
echo

ASSETS=(
  "/favicon.ico"
  "/apple-touch-icon.png"
  "/apple-touch-icon-precomposed.png"
  "/assets/howdy.css"
  "/assets/howdy.js"
)

asset_fails=0
for asset in "${ASSETS[@]}"; do
  url="${BASE_URL}${asset}"
  code="$(http_code "$url")"
  [[ -n "$code" ]] || code="???"

  printf "%-45s " "$asset"
  if [[ "$code" =~ ^2[0-9][0-9]$ ]]; then
    ok "Pass"
  else
    ((asset_fails++))
    fail "Fail (HTTP $code)"
  fi
done

# -----------------------------
# Endpoints
# -----------------------------
echo
echo "Checking endpoints..."
echo

endpoint_fails=0

# Root
url="${BASE_URL}/"
code="$(http_code "$url")"
[[ -n "$code" ]] || code="???"
printf "%-45s " "/"
if [[ "$code" =~ ^2[0-9][0-9]$ ]]; then
  ok "Pass"
else
  ((endpoint_fails++))
  fail "Fail (HTTP $code)"
fi

while IFS= read -r ep; do
  url="${BASE_URL}/${ep}/"
  code="$(http_code "$url")"
  [[ -n "$code" ]] || code="???"

  printf "%-45s " "/${ep}/"
  if [[ "$code" =~ ^2[0-9][0-9]$ ]]; then
    ok "Pass"
  else
    ((endpoint_fails++))
    fail "Fail (HTTP $code)"
  fi
done < <(discover_endpoints)

echo

if (( endpoint_fails == 0 && asset_fails == 0 )); then
  exit 0
else
  exit 1
fi
