#!/usr/bin/env bash
# bin/e2e
set -euo pipefail

BASE_URL="http://howdy.localhost"

# Green/Red (ANSI)
GREEN="$(printf '\033[0;32m')"
RED="$(printf '\033[0;31m')"
RESET="$(printf '\033[0m')"

# Curated list of assets
ASSETS=(
  "/favicon.ico"
  "/apple-touch-icon.png"
  "/apple-touch-icon-precomposed.png"
  "/assets/howdy.css"
  "/assets/howdy.js"
)

# Curated endpoint list (edit as needed)
# Note: includes trailing slash because NGINX redirects /foo -> /foo/
# TODO: 404 page
# TODO: 500 page
ENDPOINTS=(
  "/"
  "/dotnet-aspnet/"
  "/elixir-bandit/"
  "/elixir-phoenix/"
  "/go/"
  "/java-spring-boot/"
  "/javascript-inertia/"
  "/javascript-jquery/"
  "/javascript-react/"
  "/javascript-stimulus/"
  "/javascript-vue/"
  "/javascript/"
  "/ruby-on-rails/"
  "/ruby/"
  "/rust-leptos/"
  "/zig/"
)

# Curl settings:
# -sS: silent but show errors
# -L: follow redirects
# --max-time: keep it snappy
# -o /dev/null: we only care about status
CURL_COMMON=(
  -sS
  -L
  --max-time 8
  -o /dev/null
  -w "%{http_code}"
)

pad_dots() {
  # Print dots so the status lines up nicely
  # Args: label max_width
  local label="$1"
  local max="$2"
  local len="${#label}"
  local dots=$(( max - len ))
  if (( dots < 3 )); then dots=3; fi
  printf "%s" "$label"
  printf '%*s' "$dots" '' | tr ' ' '.'
}

expected_for_path() {
  # Return a case-insensitive substring to look for in the response body.
  # Empty string means "no body assertion".
  #
  # Keep assertions lightweight and stable (donâ€™t couple to fragile markup).
  local path="$1"

  printf "%s" "Howdy"
}

fetch_body() {
  # Fetch body as text. We keep it simple: follow redirects, time out quickly.
  local url="$1"
  curl -sS -L --max-time 8 "$url" 2>/dev/null || true
}

assert_body_contains() {
  local body="$1"
  local expected="$2"

  # Case-insensitive fixed string match
  printf "%s" "$body" | grep -qiF "$expected"
}

# Compute label width for pretty alignment
MAX_ASSETS_LABEL=0
for ep in "${ASSETS[@]}"; do
  label="${BASE_URL}${ep}"
  (( ${#label} > MAX_ASSETS_LABEL )) && MAX_ASSETS_LABEL=${#label}
done
MAX_ASSETS_LABEL=$(( MAX_ASSETS_LABEL + 8 )) # room for dots

MAX_ENDPOINTS_LABEL=0
for ep in "${ENDPOINTS[@]}"; do
  label="${BASE_URL}${ep}"
  (( ${#label} > MAX_ENDPOINTS_LABEL )) && MAX_ENDPOINTS_LABEL=${#label}
done
MAX_ENDPOINTS_LABEL=$(( MAX_ENDPOINTS_LABEL + 8 )) # room for dots

asset_fails=0
endpoint_fails=0

echo "Howdy World E2E (HTTP smoke)"
echo "Base: ${BASE_URL}"

echo
echo "Checking assets..."

for asset in "${ASSETS[@]}"; do
  url="${BASE_URL}${asset}"

  # shellcheck disable=SC2068
  code="$(curl "${CURL_COMMON[@]}" "$url" 2>/dev/null || true)"

  pad_dots "$url " "$MAX_ASSETS_LABEL"

  if [[ "$code" =~ ^2[0-9][0-9]$ ]]; then
    printf "%bPass%b\n" "$GREEN" "$RESET"
  else
    ((asset_fails++))
    # If curl failed entirely, code may be empty; show ???
    [[ -n "$code" ]] || code="???"
    printf "%bFail%b (HTTP %s)\n" "$RED" "$RESET" "$code"
  fi
done

echo
echo "Checking endpoints..."

for ep in "${ENDPOINTS[@]}"; do
  url="${BASE_URL}${ep}"

  # shellcheck disable=SC2068
  code="$(curl "${CURL_COMMON[@]}" "$url" 2>/dev/null || true)"

  pad_dots "$url " "$MAX_ENDPOINTS_LABEL"

  if [[ "$code" =~ ^2[0-9][0-9]$ ]]; then
    expected="$(expected_for_path "$ep")"

    if [[ -z "$expected" ]]; then
      printf "%bPass%b (HTTP %s)\n" "$GREEN" "$RESET" "$code"
      continue
    fi

    body="$(fetch_body "$url")"

    if assert_body_contains "$body" "$expected"; then
      printf "%bPass%b (HTTP %s)\n" "$GREEN" "$RESET" "$code"
    else
      ((endpoint_fails++))
      printf "%bFail%b (HTTP %s, missing '%s')\n" "$RED" "$RESET" "$code" "$expected"
    fi
  else
    ((endpoint_fails++))
    [[ -n "$code" ]] || code="???"
    printf "%bFail%b (HTTP %s)\n" "$RED" "$RESET" "$code"
  fi

done

echo
if (( asset_fails == 0 )); then
  printf "%bAll assets passing.%b\n" "$GREEN" "$RESET"
else
  printf "%b%d asset(s) failing.%b\n" "$RED" "$asset_fails" "$RESET"
fi

echo
if (( endpoint_fails == 0 )); then
  printf "%bAll endpoints passing.%b\n" "$GREEN" "$RESET"
else
  printf "%b%d endpoint(s) failing.%b\n" "$RED" "$endpoint_fails" "$RESET"
fi

echo
if (( asset_fails == 0 && endpoint_fails == 0 )); then
  exit 0
else
  exit 1
fi
