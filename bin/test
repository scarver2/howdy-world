#!/usr/bin/env bash
# bin/test
source "$(dirname "$0")/_lib.sh"

echo "Checking assets..."
echo

ASSETS=(
  "/favicon.ico"
  "/apple-touch-icon.png"
  "/apple-touch-icon-precomposed.png"
  "/assets/howdy.css"
  "/assets/howdy.js"
)

asset_fails=0
for asset in "${ASSETS[@]}"; do
  url="${BASE_URL}${asset}"
  code="$(http_code "$url")"
  [[ -n "$code" ]] || code="???"

  printf "%-45s " "$asset"
  if [[ "$code" =~ ^2[0-9][0-9]$ ]]; then
    ok "Pass"
  else
    ((asset_fails++))
    fail "Fail (HTTP $code)"
  fi
done

echo
echo "Checking endpoints..."
echo

endpoint_fails=0
for ep in "" $(discover_endpoints); do
  if [[ -z "$ep" ]]; then
    url="${BASE_URL}/"
    label="/"
  else
    url="${BASE_URL}/${ep}/"
    label="/${ep}/"
  fi

  code="$(http_code "$url")"
  [[ -n "$code" ]] || code="???"

  printf "%-45s " "$label"
  if [[ "$code" =~ ^2[0-9][0-9]$ ]]; then
    ok "Pass"
  else
    ((endpoint_fails++))
    fail "Fail (HTTP $code)"
  fi
done

echo

if (( endpoint_fails == 0 && asset_fails == 0 )); then
  exit 0
else
  exit 1
fi
