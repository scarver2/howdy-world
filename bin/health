#!/usr/bin/env bash
# bin/health
set -euo pipefail

source "$(dirname "$0")/_lib.sh"
cd "$ROOT_DIR"

usage() {
  cat <<'USAGE'
Usage:
  bin/health
  bin/health --strict

Checks endpoint contract consistency.

Default mode:
  - Missing optional items → warning
  - Missing endpoint bin contract → warning
  - Exit 0 unless required core files missing

Strict mode:
  - Missing optional items → warning
  - Missing endpoint bin contract → failure
  - Exit 1 on any contract violation
USAGE
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

STRICT=0
[[ "${1:-}" == "--strict" ]] && STRICT=1

REQUIRED=(
  Dockerfile
  compose.yml
  .dockerignore
  .gitignore
  README.md
)

OPTIONAL=(
  Dockerfile.dev
  compose.dev.yml
  TODO.md
  NOTES.md
)

BIN_REQUIRED=(
  clean
  down
  outdated
  restart
  run
  setup
  start
  stop
  up
)

fail_count=0
warn_count=0

echo "Howdy World Endpoint Health"
echo

for dir in */ ; do
  dir="${dir%/}"

  [[ "$dir" == .* ]] && continue
  [[ "$dir" == _* ]] && continue

  skip=0
  for item in "${BLACKLIST[@]}"; do
    [[ "$dir" == "$item" ]] && skip=1
  done
  [[ "$skip" == "1" ]] && continue

  echo "$dir"

  # --------------------------
  # Core Required Files
  # --------------------------

  for file in "${REQUIRED[@]}"; do
    if [[ -f "$dir/$file" ]]; then
      printf "  %-20s %b✔%b\n" "$file" "$GREEN" "$RESET"
    else
      printf "  %-20s %b✖%b\n" "$file" "$RED" "$RESET"
      ((fail_count++))
    fi
  done

  # --------------------------
  # Optional Files
  # --------------------------

  for file in "${OPTIONAL[@]}"; do
    if [[ -f "$dir/$file" ]]; then
      printf "  %-20s %b✔%b\n" "$file" "$GREEN" "$RESET"
    else
      printf "  %-20s %b~%b\n" "$file" "$YELLOW" "$RESET"
      ((warn_count++))
    fi
  done

  # --------------------------
  # Endpoint bin Contract
  # --------------------------

  if [[ -d "$dir/bin" ]]; then
    for script in "${BIN_REQUIRED[@]}"; do
      if [[ -f "$dir/bin/$script" ]]; then
        printf "  bin/%-16s %b✔%b\n" "$script" "$GREEN" "$RESET"
      else
        if (( STRICT == 1 )); then
          printf "  bin/%-16s %b✖%b\n" "$script" "$RED" "$RESET"
          ((fail_count++))
        else
          printf "  bin/%-16s %b~%b\n" "$script" "$YELLOW" "$RESET"
          ((warn_count++))
        fi
      fi
    done
  else
    if (( STRICT == 1 )); then
      printf "  %-20s %b✖%b\n" "bin/" "$RED" "$RESET"
      ((fail_count++))
    else
      printf "  %-20s %b~%b\n" "bin/" "$YELLOW" "$RESET"
      ((warn_count++))
    fi
  fi

  echo
done

require_file_headers

echo "Summary:"
printf "  %bFailures:%b %d\n" "$RED" "$RESET" "$fail_count"
printf "  %bWarnings:%b %d\n" "$YELLOW" "$RESET" "$warn_count"
echo

if (( fail_count > 0 )); then
  exit 1
fi

if (( STRICT == 1 && warn_count > 0 )); then
  exit 1
fi

exit 0
