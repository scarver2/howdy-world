#!/usr/bin/env bash
# bin/health
source "$(dirname "$0")/_lib.sh"
cd "$ROOT_DIR"

STRICT=0
[[ "${1:-}" == "--strict" ]] && STRICT=1

fail_count=0
warn_count=0

echo "Howdy World Endpoint Health"
echo

for dir in $(discover_endpoints); do
  echo "$dir"

  for file in "${REQUIRED[@]}"; do
    if [[ -f "$dir/$file" ]]; then
      printf "  %-18s %b✔%b\n" "$file" "$GREEN" "$RESET"
    else
      printf "  %-18s %b✖%b\n" "$file" "$RED" "$RESET"
      ((fail_count++))
    fi
  done

  for file in "${OPTIONAL[@]}"; do
    if [[ -f "$dir/$file" ]]; then
      printf "  %-18s %b✔%b\n" "$file" "$GREEN" "$RESET"
    else
      printf "  %-18s %b~%b\n" "$file" "$YELLOW" "$RESET"
      ((warn_count++))
    fi
  done

  echo
done

if (( fail_count > 0 )); then exit 1; fi
if (( STRICT == 1 && warn_count > 0 )); then exit 1; fi
exit 0
