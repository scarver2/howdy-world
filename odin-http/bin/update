#!/usr/bin/env bash
# odin-http/bin/update

source "$(dirname "$0")/_lib.sh"

ROOT="$(endpoint_root)"
cd "$ROOT"

require_brew
require_cmd git

hr
info "Updating dependency: deps/odin-http"
hr

[ -d "$ROOT/deps/odin-http" ] || die "Missing deps/odin-http"

if is_submodule "$ROOT/deps/odin-http"; then
  is_git_repo "$ROOT" || die "Submodule detected but endpoint root is not a git repo"
  info "Submodule detected. Updating via superproject..."
  git -C "$ROOT" submodule update --remote --merge deps/odin-http
  git -C "$ROOT/deps/odin-http" status -sb || true
else
  if is_git_repo "$ROOT/deps/odin-http"; then
    info "Git worktree detected. Pulling latest..."
    git -C "$ROOT/deps/odin-http" fetch --prune
    git -C "$ROOT/deps/odin-http" pull --ff-only
    git -C "$ROOT/deps/odin-http" status -sb || true
  else
    warn "deps/odin-http is not a git repo. Update manually by replacing contents."
  fi
fi

hr
info "Updating toolchain via Homebrew"
hr

brew update
brew upgrade odin || true
brew upgrade llvm || true
brew upgrade llvm@21 || true
brew upgrade llvm@20 || true

info "Done."
